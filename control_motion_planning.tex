\section{Control and Motion Planning}

Dynamics of a dynamical system can be given by firt order form:
\begin{align}
    \begin{split}
        \label{eq:sys}
        \dot{\mathbf{x}} &= f(\mathbf{x}, \mathbf{u}) \\   
        \text{where, }\\
        \mathbf{x} &: \text{state of system} \\
        \mathbf{u} &: \text{control input}     
    \end{split}
\end{align}

We will try to answer 2 question:

\paragraph{Motion Planning or trajectory generation:} Given set of way points and some constraints (obstacles, input saturations), Find a faesible trajectory for our system to follow. Formally (sec. 1.1.1 \cite{geering2007optimal}), find state trajecotry $x:[t_a,t_b] \mapsto \mathbb{R}^n$ and corresponding input trajectory $u:[t_a,t_b] \mapsto \mathbb{R}^m$,  such that our dynamical system \eqref{eq:sys} is transferred from initial state, $x(t_a)=\mathbf{x_a})$ to admissible final state $x(t_b) \in \Omega_f \subset \mathbb{R}^n$ and such that corresponding state traj $x(\circ)$ satisfies constraints $x(t) \in \Omega_x \subset \mathbb{R}^n , u(t) \in \Omega_u \subset \mathbb{R}^m \forall t\in [t_a, t_b]$. Sidenote: An optimal control problem would additionall
minimize some cost $J(\textbf{u})$.

\paragraph{Tracking controller: } In and ideal world, our dynamical model would be completely accurate and there will be no noise/disturbances, we would execute our above input trajectory and reach admissible final state $\Omega_f$. This is called \textbf{open loop control}. But world is not ideal, and in practice we have modelling uncertainites and disturbances. In order to track our trajectory, we have to constantly make corrective inputs by taking feedback of the current state. This is called \textbf{closed loop control}

Above 2 problems are studied extensively in field of control theory. Control of our vehicle can be thought as two seperate controllers, One for VTOL phase when forces and moments are primarily generated by diffrential thrust. During VTOL phase lifting surfaces have negligible control effects and can be ignored. While during forward flight, we shut down vertical facing propellers and all all forces, moments are generated by lifting surfaces(wings, elevons).

In this section, we study control of quadrotors and slightly more complex but interesting case of VTOL fixed wing tailsitters.

\subsection{Quadrotors}
Quadrotors are specific case of more general multi-rotor UAVs. Quadrotors have become primarily popular, as it has contains no complex or high stress moving parts unlike swash plates in helicopters. Additionaly conventional wisdom says, atleast 4 coplanar actuators are needed for good controllability. Since, our UAV has 4 top facing propellers, study of control of quadrotors is relevant. We primarily refer to \cite{mellinger2011minimum} and \cite{lee2010geometric}.

\subsubsection{Dynamics}

Newtons equation of motion governing accelertaion of center of mass(COM) is:
\begin{align*}
    m\ddot{\mathbf{x}}^\mathcal{I} &= \prescript{\mathcal{I}}{}R_{\mathcal{B}} \mathbf{f}^{\mathcal{B}}_{\text{tot}} + m\mathbf{g}^{\mathcal{I}} \\
    \text{where,}\\
    m&: \text{mass of quadrotor}\\
    \mathcal{I} &: \text{Intertial(world) frame}\\
    \mathcal{B} &: \text{Body frame}\\
    \mathbf{x}^\mathcal{I}&: \text{position vector of COM in frame } \mathcal{I}\\
    \prescript{\mathcal{I}}{}R_{\mathcal{B}}&: \text{Rotation matrix from }\mathcal{B} \text{ to }\mathcal{I}\\
    \mathbf{f}_{\text{tot}}&: \text{Thrust exerted (by propellers)}\\
    \mathbf{g}^{\mathcal{I}}&: -\begin{pmatrix}0\\0\\g\end{pmatrix}^\mathcal{I}
\end{align*}

We use notation, $\begin{pmatrix}p\\q\\r\end{pmatrix}^\mathcal{F}$ to denote vector in basis components $p e^\mathcal{F}_x + p e^\mathcal{F}_y + p e^\mathcal{F}_z$ of frame $\mathcal{F}$.

Further, euler equation of motion gives:
\begin{align*}
    \tau^{\mathcal{B}}_\text{tot} &= I\ddot{\theta}_\mathcal{BI} + \dot{\theta}_\mathcal{BI} \times I\dot{\theta}_\mathcal{BI}\\
    I &: \text{inertia matrix in body frame}\\
    \dot{\theta}_\mathcal{BI} &: \text{angular velocity of $\mathcal{B}$ w.r.t $\mathcal{I}$}\\
    \ddot{\theta} &: \text{angular acc.}\\
\end{align*}

Force is generated by thrust producing deices ie. propellers driven by indivisually controlled motors. Force by single propeller is modelled as:
\begin{align*}
    \mathbf{f}_\text{prop} &= \kappa_f \omega_p^2 \mathbf{e}_n\\
    \text{where,}\\
    \kappa_f&:\text{force constant of propellers}\\
    \omega_p&:\text{rpm of props}\\
    \mathbf{e}_n&:\text{unit vector normal to plane of rotation}
\end{align*}

Here, all the complexity is hidden by $\kappa_f$, which is a function of propeller diameter, blades airfoil section profile along span and angle of attack with rotating plane. In theory, $\kappa_f$ will vary with advance ratio $J$ and air speed $v_\infty$ (sec. 9.2 \cite{anderson2005introduction}).

We will choose a fixed pitch propeller, optimized for chosen climb and cruise speed and ignore variation in effeciency due to air speed$v\infty$ as our flight speed envelope is small.

Finding $\kappa_f$ may look like a complex task. But can be found quite simply by experimentally varying $\omega_p$ from 0 to $\omega_p^max$ and measuring Thrust respectively using load cells(weighing scale). This data is in turn fit as quadratic model to get $\kappa_p$.

Drag by each prop blade and thrust produced results to moments in body frame:
\begin{align*}
    \tau_\text{prop}^\mathcal{B} &= \text{sgn}(\omega_p) \kappa_m \mathbf{e}_z^\mathcal{B}
    + \mathbf{l}^\mathcal{B}\times \mathbf{f}_\text{prop}^\mathcal{B}\\
    \text{where,}\\
    \text{sgn} &: \pm1 \text{ depending on direction of rotation}\\
    \mathbf{l} &: \text{position of prop w.r.t COM}\\
\end{align*}

Summing up indivisual forces and moments gives:

\begin{align*}
    \mathbf{f}_\text{tot} &= \sum_{i=1}^{N=4} \mathbf{f}_{\text{prop},i}\\
    \tau_\text{tot} &= \sum \tau_{\text{prop},i}\\
    &= \kappa_m (\sum_{i=1}^{N=4} \text{sgn}(\omega_i)\omega_i^2) \mathbf{e_z} + \sum \mathbf{l}_{p,i}\times \kappa_f \omega_{p,i}^2 \mathbf{e}_z\\
\end{align*}

Commonly, props are chosen to rotate in opposite directions alternatively(\cite{tayebi2006attitude} \cite{castillo2004stabilization} \cite{lee2010geometric}), thus sgn($\omega_{p,i}$) can be replaced by:
\begin{equation*}
    \text{sgn}(\omega_{p,i}) = (-1)^i
\end{equation*}

and $\mathbf{l}_{p,i}$ are placed such that they align with body axes $x^\mathcal{B}$ and $y^\mathcal{B}$ giving:
\begin{equation*}
    \begin{bmatrix}\mathbf{l_1} & \mathbf{l_2} & \mathbf{l_3} & \mathbf{l_4} \end{bmatrix} = \begin{bmatrix}
        \begin{pmatrix}L\\0\\0\end{pmatrix} & \begin{pmatrix}0\\L\\0\end{pmatrix} & \begin{pmatrix}-L\\0\\0\end{pmatrix} & \begin{pmatrix}0\\-L\\0\end{pmatrix}
    \end{bmatrix}
\end{equation*}

Having defined dynamics of quadrotor, we begin to introduce technique in non-linear control theory callled diffrential flatness in next section.

\section{Diffrential Flatness}
Roughly speaking, a  system is diffrentially flat if, we can find a set of ouputs, equal to number of inputs s.t all states and inputs can be determined from these outputs without integration\cite{murray1995differential}.

Formally, the system is diff. flat if we can find outputs $y \in \mathbb{R}^m$ of form:
\begin{align*}
    y &= y(x, u, \dot{u}, \dots u^{(p)}) \\
\text{such that, }\\
x &= x(y, \dot{y}, \dots y^{(q)}) \\
u &= u(y, \dot{y}, \dots y^{(q)}) \\
\end{align*}

\subsection{Quadrotor: Diffrential flatness}
Trajectory generation for quadrotor in presence of obstacles and tracking this trajectory becomes easy as quadrotor can be shown to be diff. flat \cite{mellinger2011minimum} in outputs:
\begin{align*}
    \mathbf{y} &= \begin{pmatrix} \mathbf{x}^\mathcal{I}_b \\ \psi \end{pmatrix}\\
    y &:[t_a, t_b] \mapsto \mathbb{R}^3 \times SO(2)\\
    \mathbf{x}^\mathcal{I}_b &: \text{positiong of quadrotor in $\mathcal{I}$ frame}\\
    \psi &: \text{yaw angle}
\end{align*}
\subsubsection{Tracking controller}
Tracking controller is simple PD controller in SO(3) to avoid singularities. PD control on flat outputs is more stable to parameter changes than on entire state \cite{Anintrod8:online}.
\begin{align*}
    \mathbf{e}_p &= \mathbf{x} - \mathbf{x}_T \\
    \mathbf{e}_v &= \mathbf{\dot{x}} - \mathbf{\dot{x}}_T \\
    \textbf{f}_\text{tot} &= \textbf{f}_T - K_p \mathbf{e}_p - K_v \mathbf{e}_v \\
    \text{where,} \\
    K_\alpha &: \text{gain matrices} \\
\end{align*}
$R_T$ is simply as function of flat outputs, which gives error in SO(3) \cite{bullo2004geometric}:
\begin{align*}
    \mathbf{e}_R &= \frac{1}{2} (R_T^T R_\text{est} - R_\text{est}^T R_T)\\
    \mathbf{e}_\omega &= \omega_{\mathcal{BW},\text{est}} - \omega_{\mathcal{BW},T}\\
    \tau_\text{tot} &= -K_r \mathbf{e}_R - K_\omega \mathbf{e}_\omega \\
\end{align*}

$\begin{pmatrix} \|\textbf{f}_\text{tot}\| \\ \tau_\text{tot} \end{pmatrix}$ will give indivisual inputs $\begin{pmatrix}u_1\\u_2\\u_3\\u_4\end{pmatrix}$ by simply multiplying with inverse of a contant matrix $A^{-1}$ \cite{mellinger2011minimum}.

\subsubsection{Trajecotry generation}

For trajectory generation in presence of obstacles, refer to \cite{mellinger2011minimum}.

\subsection{Aircraft: Diffrential flatness}
This is of our interest as we want to control and generate trajectory our hybrid VTOl in forward flight too. Fixed wing Aircraft has been shown to be diff. flat. For Trajectory generation and controller design we refer to (Chapter 14: Automatic Flight Control Systems \cite{levine2009analysis})

\section{Tailsitter}
TODO: add here

\section{LQR controller}
TODO: add Here
